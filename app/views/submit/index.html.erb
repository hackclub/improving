<%= csrf_meta_tags %>
<%# css isnt real #%>
<%# YSWS DB FORMAT FYI #%>
<%= form_with url: "/submit", method: :post, local: true, class: "space-y-6 max-w-4xl mx-auto p-6" do |f| %>

  <!-- Section 1: Code + Demo URLs -->
  <div class=" rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Links</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <%= f.label :code_url, "Code URL", class: "block text-sm font-medium" %>
        <%= f.url_field :code_url, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500",required: true %>
      </div>
      <div>
        <%= f.label :demo_url, "Demo URL", class: "block text-sm font-medium" %>
        <%= f.url_field :demo_url, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500",required: true  %>
      </div>
    </div>
  </div>

  <!-- Section 2: Identity -->
  <div class=" rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Who are you?</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <%= f.label :first_name, "First Name", class: "block text-sm font-medium"  %>
        <%= f.text_field :first_name, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div>
        <%= f.label :last_name, "Last Name", class: "block text-sm font-medium"  %>
        <%= f.text_field :last_name, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500",required: true  %>
      </div>
      <div>
        <%= f.label :email, "Email", class: "block text-sm font-medium"  %>
        <%= f.email_field :email, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500",required: true  %>
      </div>
     <div>
  <%= f.label :slack_id, "Slack ID", class: "block text-sm font-medium",required: true %>
  <%= f.text_field :slack_id, 
        value: @slack_id,  # <-- auto-fill from controller
        class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
</div>
    </div>
  </div>

  <!-- Section 3: Ship Info -->
  <div class=" rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Your Ship</h2>
    <div class="space-y-4">
      <div>
        <%= f.label :ship_name, "Ship Name", class: "block text-sm font-medium",required: true %>
        <%= f.text_field :ship_name, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div>
        <%= f.label :description, "Description", class: "block text-sm font-medium",required: true %>
        <%= f.text_area :description, rows: 3, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div class="flex items-center gap-2">
        <%= f.check_box :is_hardware, class: "h-4 w-4 text-indigo-600 border-gray-300 rounded" %>
        <%= f.label :is_hardware, "This is a hardware project", required: true  %>
      </div>
      <div>
        <%= f.label :video_upload, "Upload Video", class: "block text-sm font-medium" %>
        <%= f.file_field :video_upload, accept: "video/*", class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2",required: true %>
      </div>
    </div>
  </div>

  <!-- Section 4: Extra Info -->
  <div class=" rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Extra Info</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <%= f.label :birthday, "Birthday", class: "block text-sm font-medium" %>
        <%= f.date_field :birthday, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
   <div class=" rounded-2xl shadow p-6 space-y-4">
  <h2 class="text-xl font-semibold">Address</h2>
  <div class="space-y-4">
    <div>
      <%= f.label :street, "Street Address", class: "block text-sm font-medium" %>
      <%= f.text_field :street, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
    </div>

    <div>
      <%= f.label :address_line2, "Address Line 2", class: "block text-sm font-medium" %>
      <%= f.text_field :address_line2, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500"  %>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <%= f.label :city, "City", class: "block text-sm font-medium" %>
        <%= f.text_field :city, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div>
        <%= f.label :state, "State/Province", class: "block text-sm font-medium" %>
        <%= f.text_field :state, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div>
        <%= f.label :zip, "ZIP/Postal Code", class: "block text-sm font-medium" %>
        <%= f.text_field :zip, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
    </div>

    <div>
      <%= f.label :country, "Country", class: "block text-sm font-medium" %>
      <%= f.text_field :country, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      <!-- Or use a select if you want a dropdown -->
      <%#= f.select :country, ISO3166::Country.all.map { |c| [c.name, c.alpha2] }, {}, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
    </div>
  </div>
</div>

      <div>
        <%= f.label :shipping_name, "Shipping Name", class: "block text-sm font-medium" %>
        <%= f.text_field :shipping_name, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
      <div>
        <%= f.label :github_username, "GitHub Username", class: "block text-sm font-medium" %>
        <%= f.text_field :github_username, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", required: true  %>
      </div>
    <div>
  <%= f.label :hackatime_project, "Hackatime Project (optional)", class: "block text-sm font-medium" %>
  <%= f.select :hackatime_project, [], { prompt: "Select hours" }, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", id: "hackatime_project_select" %>
</div>
<div>
        <%= f.label :hours_collected, "Hours Collected (optional)", class: "block text-sm font-medium" %>
        <%= f.number_field :hours_collected, step: 1, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500", value: 0  %>
      </div>
    </div>
  </div>

  <!-- Section 5: Prize + Gallery -->
  <div class=" rounded-2xl shadow p-6 space-y-4">
    <h2 class="text-xl font-semibold">Prize & Gallery</h2>
    <div>
      <%= f.label :desired_prize, "What prize do you want?", class: "block text-sm font-medium" %>
      <%= f.text_field :desired_prize, class: "mt-1 block w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-indigo-500" %>
    </div>
    <div class="flex items-center gap-2">
      <%= f.check_box :in_gallery, class: "h-4 w-4 text-indigo-600 border-gray-300 rounded" %>
      <%= f.label :in_gallery, "Include my project in the gallery" %>
    </div>
  </div>

  <!-- Submit -->
  <div class="flex justify-end">
    <%= f.submit "Submit Ship", class: "px-6 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300" %>
  </div>
<% end %>

<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
fetch('/api/verify'+window.location.search, {
headers: {
    "User-Agent": "Improving/v1.0 +hackclub/client",
     "X-CSRF-Token": csrfToken
}  
}).then(r=>r.json()).then(dbb=> {
    const d = dbb.body
    if(d.error || !d.identity_response) {
        if(d.error == "Submit token already used" || d.error.includes('Missing required parameters:') || !d.identity_response) {
        window.location.href = "https://submit.hackclub.com/improving"
        return;
    }
    }
    const url = new URL(window.location);
url.search = ""; // remove query string
window.history.replaceState({}, document.title, url);
    console.log(d, 'omg data')
    // time to autofill
    const info = d.identity_response
    
    document.querySelector("#first_name").value = info.first_name
    document.querySelector("#last_name").value = info.last_name
    document.querySelector("#email").value = new URLSearchParams(window.location.search).get('email')
    document.querySelector('#birthday').value = info.birthday
    const addr = info.addresses[0]
    if(addr) {
        document.querySelector('#street').value = addr.line_1
     if( addr.line_2)  document.querySelector('#address_line2').value = addr.line_2
        document.querySelector('#city').value = addr.city
        document.querySelector('#state').value = addr.state
        document.querySelector('#zip').value = addr.postal_code
        document.querySelector('#country').value = addr.country
        document.querySelector('#shipping_name').value = `${addr.first_name} ${addr.last_name}`
    }
        // todo make gh username autofiller
      document.querySelector('#code_url').oninput = (e) => {
    const textValue = e.target.value
   const match = textValue.match(/github\.com\/([a-zA-Z0-9-]+)(?:\/|$)/)
   console.log(match)
    if (match) {
  console.log(match[1]);
  document.querySelector("#github_username").value = match[1]
}
      }
        // todo make hackatime proj finder.
    function onSlackIdUpdate() {
      const slackId = document.querySelector("#slack_id").value
    // fetch hackatime now! 
    if(slackId.length < 10) {
        // uhhhh error
        return;
    }
    
    fetch(`https://hackatime.hackclub.com/api/v1/users/${slackId}/stats?start_date=2025-08-30&end_date=2025-09-30&features=projects`).then(r=>r.json()).then(json => {
      if(json.error) {
        // uhhhh error
        // TODO add error msg as select option or js disable the select menu
        document.querySelector('#hackatime_project_select').innerHTML = `<option select>${json.error}</option>`
        return;
      }
      if(json.trust_factor) {
        if(json.trust_factor.trust_value == 1) {
          // #banned
          // TODO add banned option thingymajic 
      Array.from(document.querySelectorAll('input')).forEach(i => i.disabled = true)
      alert("You are hackatime banned; you cannot submit for this ysws")
      window.location.href = "/"
          return;
        }
        if(json.data) {
          if(json.data.projects.length > 0) {
          // add projects
          for(const project of json.data.projects) {
            const n = project.name 
            const hrs = project.hours
            const opt = document.createElement('option')
            opt.value = project.name
            opt.innerText = `${n} - ${hrs} hours`
            document.querySelector('#hackatime_project_select').appendChild(opt)
          }
          }
  document.querySelector('#hackatime_project_select').onchange = (e) => {
  const selectedValue = e.target.value; // the new value of the select

  // do some logic to compute hours
  const hours = json.data.projects.find(p => p.name == selectedValue)?.hours;

  // update the element
  const hoursElement = document.querySelector('#hours_collected');

  // If it's a text element like <span> or <div>
  hoursElement.value = hours;
  }
        }
      }
    })
    }
    setTimeout(
    onSlackIdUpdate, 500
    )
    document.querySelector("#slack_id").oninput = onSlackIdUpdate
    // document.querySelector("#slack_id").onchange = onSlackIdUpdate
    // then add it to the list if user isnt banned please also error handle
    
    debugger;  
})
</script>